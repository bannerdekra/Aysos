# 更新日志 - 2025-10-24

## 🎨 UI/UX 优化

### 1. 气泡功能按钮动态对齐 ✅

#### ✨ 功能概述
优化聊天气泡侧的功能按钮（复制、删除、修改）位置跟随逻辑，实现鼠标高度动态对齐。

#### 📋 主要特性

1. **动态垂直对齐**
   - 气泡功能按钮根据鼠标在气泡内的垂直位置实时调整
   - 鼠标移动时，按钮始终对齐到相同高度
   - 子控件（如文本标签）的鼠标事件也触发位置更新

2. **延迟隐藏机制**
   - 鼠标离开气泡后，按钮延迟 2 秒隐藏
   - 避免鼠标快速移动时按钮闪烁
   - 保持最后的鼠标位置，离开时按钮停留在该高度

3. **边界保护**
   - 按钮 Y 坐标限制在气泡高度范围内
   - 全局窗口边界检查，防止按钮超出可见区域
   - 水平间距缩小（AI 气泡按钮与气泡边缘从 10px 减至 3px）

4. **复制成功反馈**
   - 点击复制按钮后，按钮文字变为"已复制!"
   - 背景色临时变为绿色（800ms）
   - 自动恢复原始样式

#### 🔧 技术实现

**核心修改**：`bubble_copy_handler.py`

1. **鼠标追踪增强**
   - `_register_mouse_tracking_targets()`: 为气泡内所有子控件开启鼠标追踪
   - `eventFilter()`: 捕获子控件的 MouseMove/HoverMove/Enter 事件
   - `_handle_child_mouse_activity()`: 计算子控件鼠标位置相对气泡的坐标

2. **位置计算**
   - 子控件局部坐标 → 全局坐标 → 气泡局部坐标
   - Y 坐标钳位到 `[0, bubble_height]` 范围
   - 按钮高度居中偏移：`button_y = bubble_y + mouse_y - button_height // 2`

3. **延迟隐藏**
   - `hide_timer`: QTimer 单次触发，延迟 2000ms
   - `leaveEvent()`: 启动定时器，而非立即隐藏
   - `enterEvent()` / `mouseMoveEvent()`: 取消定时器，保持显示

4. **复制反馈**
   - `_show_copy_success_feedback()`: 临时修改按钮样式和文字
   - `QTimer.singleShot(800, ...)`: 800ms 后恢复原状

#### 📝 修改的文件

- `SoftWare/Script/bubble_copy_handler.py` (~550 行)
  - 新增 `_register_mouse_tracking_targets()` 方法
  - 新增 `eventFilter()` 方法（事件过滤器）
  - 新增 `_handle_child_mouse_activity()` 方法
  - 优化 `_update_buttons_position()` 边界检查
  - 优化 `leaveEvent()` 延迟隐藏逻辑
  - 修复 `_show_copy_success_feedback()` AttributeError

#### 🎯 用户体验提升

- ✅ 按钮不再固定在气泡中央，跟随鼠标更自然
- ✅ 离开气泡后按钮短暂保留，方便点击
- ✅ 按钮边距缩小，界面更简洁
- ✅ 复制操作有明确的视觉反馈

---

## 🎨 创作控制面板优化

### 2. SD 创作面板间距优化 ✅

#### 🔍 问题描述

用户反馈创作控制面板（Stable Diffusion）中，正向提示词和负向提示词之间的水平间距过大，导致面板显得松散。

#### ✅ 解决方案

**修改文件**：`SoftWare/Script/creation_panel.py`

**具体修改**：
```python
# 修改前
prompts_layout.setSpacing(12)

# 修改后
prompts_layout.setSpacing(8)  # 🔧 缩小正向与负向提示词之间的水平间距（12->8）
```

#### 🎯 效果

- 正向提示词和负向提示词文本框之间的间距从 12px 缩小到 8px
- 面板布局更紧凑，视觉更统一
- 与之前的垂直间距优化（标题间距、文本框高度）形成一致的紧凑风格

---

## ⚙️ 设置面板主题刷新优化

### 3. 深色模式即时刷新 ✅

#### 🔍 问题描述

在设置对话框中切换深色模式后，当前显示的子面板（如"通用设置"）没有立即刷新为新的主题颜色，需要重新切换面板或重启应用才能看到效果。

#### ✅ 解决方案

**修改文件**：`SoftWare/Script/dialogs.py`

**1. 移除防抖机制**

```python
# 修改前（on_dark_mode_toggled）
if hasattr(self.theme_manager, 'enable_dark_mode_fast'):
    self.theme_manager.enable_dark_mode_fast(checked)
else:
    self.theme_manager.enable_dark_mode(checked)

# 修改后
self.theme_manager.enable_dark_mode(checked)  # 直接调用，无延迟
```

```python
# 修改前（on_auto_mode_toggled）
QTimer.singleShot(0, lambda: self.theme_manager.set_auto_mode(enabled))

# 修改后
self.theme_manager.set_auto_mode(enabled)  # 直接调用，无延迟
```

**2. 添加面板刷新逻辑**

```python
# on_theme_manager_dark_mode_changed() 方法中新增：
current_item = self.parent_list.currentItem() if self.parent_list else None
if current_item:
    current_text = current_item.text()
    print(f"🔄 刷新当前面板: {current_text}")
    self.switch_to_parent_content(current_text)  # 重新渲染当前面板
```

#### 🎯 效果

- ✅ 点击深色模式开关后，设置面板立即变为深色/浅色
- ✅ 无延迟，无需等待
- ✅ 无需切换面板或重启应用
- ✅ 自动模式开关同样即时响应

#### 📝 技术细节

- **信号流**：开关切换 → `on_dark_mode_toggled()` → `theme_manager.enable_dark_mode()` → `theme_changed` 信号 → `on_theme_manager_dark_mode_changed()` → 刷新面板
- **防抖移除**：不再使用 `QTimer.singleShot()` 延迟调用，直接同步执行
- **面板重绘**：调用 `switch_to_parent_content()` 清空并重建当前面板，应用新主题的颜色方案

---

## 🗂️ 配置整合

### 4. 统一配置文件 ✅

#### 📋 配置整合说明

所有 UI 相关配置（主题、折叠设置等）已整合到统一的配置文件：

**配置文件路径**：`SoftWare/Script/config.json`

**配置结构**：
```json
{
  "app": {
    "ui": {
      "collapse_threshold": 500,
      "preview_length": 300
    }
  },
  "dark_mode_enabled": false,
  "auto_dark_mode": false,
  "custom_background_path": "",
  "is_video_background": false
}
```

#### 🔧 涉及的模块

1. **主题管理**
   - `theme_manager.py`: 读写 `dark_mode_enabled`、`auto_dark_mode`、`custom_background_path`
   - `enhanced_theme_manager.py`: 读写 `is_video_background`

2. **长文本折叠**
   - `chat_area.py`: 读取 `app.ui.collapse_threshold` 和 `app.ui.preview_length`
   - `dialogs.py`: 设置界面保存/加载折叠阈值

3. **废弃文件**
   - ❌ `theme_settings.json` 已不再使用（所有配置迁移到 `config.json`）

#### 🎯 优势

- ✅ 单一配置文件，易于管理和备份
- ✅ 避免配置文件碎片化
- ✅ 统一的读写接口（`_read_config()` / `_write_config()`）
- ✅ 向后兼容（缺失配置项使用默认值）

---

## 🔧 其他优化

### 5. 删除确认优化 ✅

**问题**：之前删除消息时可能出现双重确认弹窗。

**解决**：统一使用单次确认对话框，避免重复确认。

**修改文件**：`bubble_copy_handler.py` 中的 `_delete_bubble()` 方法

**代码示例**：
```python
msg_box = QMessageBox()
msg_box.setWindowTitle("确认删除")
msg_box.setText("确认删除这条消息吗？删除后无法恢复。")
msg_box.setStandardButtons(QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)

# 只在用户点击"确认删除"后才发送删除信号
if msg_box.exec() == QMessageBox.StandardButton.Yes:
    chat_window.delete_message_signal.emit(self.bubble_index)
```

---

## 📊 文件修改统计

### 核心文件修改

1. **bubble_copy_handler.py** (~550 行)
   - 新增鼠标追踪和事件过滤功能
   - 优化按钮位置计算逻辑
   - 添加延迟隐藏机制
   - 实现复制成功反馈

2. **creation_panel.py** (~688 行)
   - 调整提示词区域水平间距（1 行修改）

3. **dialogs.py** (~2335 行)
   - 移除主题切换防抖（2 处修改）
   - 添加面板刷新逻辑（1 处修改）

4. **README.md**
   - 更新项目结构说明
   - 添加 2025-10-24 变更摘要
   - 更新配置文件说明

5. **LOG/UPDATE_2025-10-24.md**（本文档）
   - 详细记录所有优化内容

### 配置文件变化

- ✅ `config.json` - 统一配置文件（主题 + UI 设置）
- ❌ `theme_settings.json` - 已废弃

---

## ✅ 测试验证

### 功能测试清单

- ✅ 气泡功能按钮随鼠标高度动态对齐
- ✅ 鼠标离开气泡后按钮延迟 2 秒隐藏
- ✅ 复制按钮点击后显示"已复制!"反馈
- ✅ 删除消息单次确认（无重复弹窗）
- ✅ SD 创作面板提示词间距更紧凑
- ✅ 设置面板切换深色模式立即刷新
- ✅ 设置面板切换自动模式立即响应
- ✅ 配置自动保存到 `config.json`
- ✅ 应用重启后配置正确恢复

### 兼容性测试

- ✅ 历史对话加载正常
- ✅ 长文本折叠功能不受影响
- ✅ 主题切换（深色/浅色）不影响气泡功能
- ✅ 视频/图片背景切换正常

---

## 🎯 用户体验提升总结

### 交互优化

1. **更自然的按钮跟随**：气泡功能按钮根据鼠标位置动态调整，操作更直观
2. **即时主题切换**：设置面板无延迟刷新，所见即所得
3. **清晰的操作反馈**：复制操作有视觉确认，删除操作单次确认
4. **更紧凑的布局**：SD 面板间距优化，屏幕空间利用更高效

### 技术改进

1. **移除防抖机制**：主题切换直接响应，无人工延迟
2. **事件过滤器**：捕获子控件鼠标事件，提升按钮跟随准确度
3. **配置整合**：单一配置文件，降低维护成本
4. **边界保护**：按钮位置全局检查，避免越界显示

---

## 📝 后续计划

### 短期优化

- 🟡 气泡按钮淡入淡出动画（提升视觉流畅度）
- 🟡 SD 创作面板参数预设功能（保存/加载常用配置）
- 🟡 折叠按钮记忆状态（记住每个气泡的展开/收起状态）

### 中期计划

- 🟢 气泡功能按钮自定义（用户可选择显示哪些按钮）
- 🟢 主题配色方案预设（多套配色快速切换）
- 🟢 设置面板搜索功能（快速定位配置项）

---

## 🤝 贡献者

- 开发者：GitHub Copilot
- 测试者：bannerdekra
- 日期：2025年10月24日
- 版本：V1.0.10 (post-release optimizations)

---

**开发日期**: 2025年10月24日  
**基于版本**: V1.0.10  
**开发者**: GitHub Copilot  
**提交者**: bannerdekra
