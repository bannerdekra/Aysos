# 更新日志 - 2025-10-18

## ✅ 静态/动态背景自由切换功能

### 🎯 功能概述
实现了图片和视频背景的无缝切换，支持以下场景：
- ✅ 图片 → 视频：正常
- ✅ 视频 → 图片：正常  
- ✅ 视频 → 视频：正常
- ✅ 启动恢复：正常（自动恢复上次设置的背景类型）

### 🏗️ 架构升级

#### 旧架构（存在问题）
```
❌ QVideoWidget（双层架构）
├─ GPU 硬件加速层（视频）
└─ Qt 软件渲染层（UI）

问题：硬件层永远在软件层之上，导致 UI 被视频覆盖
```

#### 新架构（已解决）
```
✅ QGraphicsVideoItem（统一架构）
└─ QGraphicsScene（统一渲染上下文）
   ├─ QGraphicsVideoItem (zValue=-1000) 视频在最底层
   └─ UI 组件通过 raise_() 在 Scene 容器之上

优势：
- 统一渲染上下文，精确控制 z-order
- 视频在 Scene 内享受硬件加速
- UI 在 Scene 外通过层级管理保证在上方
```

### 📝 技术实现

#### 1. 导入更新 (chat_ui.py)
```python
# 旧导入
from PyQt6.QtMultimediaWidgets import QVideoWidget

# 新导入
from PyQt6.QtWidgets import QGraphicsView, QGraphicsScene
from PyQt6.QtMultimediaWidgets import QGraphicsVideoItem
```

#### 2. 组件初始化 (chat_ui.py)
```python
# 视频背景相关 - 使用 QGraphicsVideoItem 架构
self.graphics_view = None          # QGraphicsView 容器
self.graphics_scene = None         # QGraphicsScene 场景
self.video_item = None             # QGraphicsVideoItem 视频项
self.media_player = None           # QMediaPlayer 播放器
self.audio_output = None           # QAudioOutput 音频输出
self.is_video_background = False   # 是否为视频背景模式
```

#### 3. 视频播放方法重构 (chat_ui.py)
```python
def play_video_background(self, video_path):
    """使用 QGraphicsVideoItem 架构播放视频背景"""
    # 创建 Scene 和 View（统一渲染容器）
    self.graphics_scene = QGraphicsScene(self)
    self.graphics_view = QGraphicsView(self.graphics_scene, self)
    
    # 设置鼠标穿透（关键！）
    self.graphics_view.setAttribute(Qt.WidgetAttribute.WA_TransparentForMouseEvents)
    self.graphics_view.setInteractive(False)
    
    # 创建视频项并设置为最底层
    self.video_item = QGraphicsVideoItem()
    self.graphics_scene.addItem(self.video_item)
    self.video_item.setZValue(-1000)  # 最底层
    
    # 确保 UI 在视频层上方
    self.graphics_view.lower()  # 视频容器在底层
    self.sidebar.raise_()       # UI 提升到上层
    self.input_bar.raise_()
    self.chat_area.raise_()
```

#### 4. 主题管理器支持 (enhanced_theme_manager.py)
```python
# 新增字段
self.is_video_background = False  # 是否为视频背景

# 更新方法签名
def set_custom_background(self, path, is_video=False):
    """设置自定义背景（支持图片和视频）"""
    self.custom_background_path = path
    self.is_video_background = is_video
    self.apply_background()
    self.save_settings()

# 自动判断背景类型
def apply_background(self):
    if self.is_video_background:
        self.main_window.play_video_background(self.custom_background_path)
    else:
        self.main_window.set_background_static(self.custom_background_path)

# 保存/加载设置包含视频标记
settings = {
    'custom_background_path': self.custom_background_path,
    'is_video_background': self.is_video_background
}
```

#### 5. 设置界面优化 (dialogs.py)
```python
# 更新背景选择方法
def choose_background(self):
    # 判断文件类型
    ext = os.path.splitext(file_path)[1].lower()
    is_video = ext in ['.mp4', '.avi', '.mov', '.mkv']
    
    # 传递 is_video 参数
    self.theme_manager.set_custom_background(file_path, is_video=is_video)
    
    # 显示背景类型
    bg_type = "视频" if is_video else "图片"
    self.bg_path_label.setText(f"已选择: {os.path.basename(file_path)} ({bg_type})")
```

### 🔑 核心原理

#### 渲染管线对比
```
QVideoWidget（失败原因）：
应用窗口
├─ [操作系统层] GPU Overlay（视频） ← 永远在最上层
└─ [Qt 渲染层] UI 组件 ← 被覆盖

QGraphicsVideoItem（成功原因）：
应用窗口
├─ QGraphicsView（底层容器）
│  └─ QGraphicsScene（统一场景）
│     └─ QGraphicsVideoItem (zValue=-1000) ← Scene 内最底层
└─ UI 组件（通过 raise_() 在容器之上）← 正常显示
```

#### 关键技术点
1. **统一渲染上下文**：视频在 QGraphicsScene 内，避免了操作系统层级冲突
2. **z-order 控制**：`setZValue(-1000)` 确保视频在 Scene 内的最底层
3. **鼠标穿透**：`WA_TransparentForMouseEvents` 让鼠标事件传递给 UI
4. **层级管理**：`lower()` 视频容器，`raise_()` UI 组件

### 🎨 用户体验优化

#### 设置界面
- 支持在文件选择器中同时显示图片和视频
- 自动识别文件类型（.mp4/.avi/.mov/.mkv = 视频，.png/.jpg/.jpeg = 图片）
- 在设置中显示当前背景类型标签

#### 启动恢复
- 自动读取 `theme_settings.json` 中的 `is_video_background` 字段
- 应用启动时自动恢复上次设置的背景（图片或视频）
- 保持深色模式、自动模式等其他设置不受影响

#### 深色模式兼容
- 视频背景与深色模式完美兼容
- 深色模式蒙版（半透明黑色）正确覆盖在视频上
- 不影响视频播放

### 📦 修改的文件

1. **chat_ui.py**
   - 导入模块更新
   - 视频架构从 QVideoWidget 改为 QGraphicsVideoItem
   - 重写 `play_video_background()` 方法
   - 更新 `stop_video_background()` 方法
   - 更新 `resizeEvent()` 适配新架构

2. **enhanced_theme_manager.py**
   - 添加 `is_video_background` 字段
   - 更新 `set_custom_background()` 支持视频标记
   - 重写 `apply_background()` 自动判断类型
   - 更新 `save_settings()` 和 `load_settings()` 包含视频标记

3. **dialogs.py**
   - 更新 `choose_background()` 传递 `is_video` 参数
   - 优化 `show_general_settings()` 显示背景类型

### 🧪 测试场景

详见 `测试背景切换.md` 文件，包括：
- 场景 1: 图片 → 视频
- 场景 2: 视频 → 图片  
- 场景 3: 视频 → 视频
- 场景 4: 启动恢复
- 场景 5: 深色模式与视频背景

### 🎉 完成状态

- ✅ 架构升级完成
- ✅ 所有切换场景正常
- ✅ 启动恢复功能正常
- ✅ 深色模式兼容
- ✅ UI 层级正确
- ✅ 无编译错误
- ✅ 保持原有弹窗设置（统一白底）
- ✅ 视频作为背景持续播放

### 🙏 致谢

感谢您提供的 QGraphicsVideoItem 解决方案思路！这个架构完美解决了 GPU 硬件层覆盖 UI 的问题。

---

**更新时间**: 2025年10月18日  
**版本**: 1.0.10  
**开发者**: GitHub Copilot
