# 2025-10-05 更新内容总结

## 主要更新

### 1. 高级文本搜索功能（全新实现）

#### 1.1 搜索对话框增强
- **SearchDialog** 对话框完全重构，尺寸扩大至 `500x250`
- 新增搜索结果计数显示："已查找到 X 处内容，现在显示的是 Y/X 处"
- 结果提示使用灰色字体，与深色/浅色主题自适应
- 错误提示使用红色字体，与正常提示区分

#### 1.2 导航功能
- **上一处/下一处导航按钮**
  - 找到 2 处及以上匹配时自动显示
  - 按钮带有方向指示符：`◀ 上一处` 和 `下一处 ▶`
  - 智能按钮状态管理：
    - 在第一个结果时，"上一处"按钮禁用
    - 在最后一个结果时，"下一处"按钮禁用
  - 按钮宽度固定为 100px，布局整齐

#### 1.3 双重高亮系统
**气泡高亮**：
- 用户消息气泡：浅绿色背景 `rgb(100, 255, 100)` + 橙色边框 `3px solid #FFA500`
- Agent 消息气泡：浅蓝色背景 `rgb(100, 200, 255)` + 橙色边框 `3px solid #FFA500`
- 边框加粗至 3px，提高视觉识别度

**关键词高亮**：
- 使用 HTML `<span>` 标签实现文本内高亮
- 匹配关键词样式：黄色背景 + 黑色粗体文字
- 支持大小写不敏感匹配（`re.IGNORECASE`）
- 使用正则表达式精确匹配完整关键词

**高亮持续时间**：
- 从 2 秒延长至 3 秒，提供更充足的阅读时间
- 3 秒后自动恢复原始样式和文本

#### 1.4 高亮锁定问题修复
**问题描述**：
快速点击"上一处"/"下一处"按钮时，多个高亮定时器叠加，导致高亮无法正常消失

**解决方案**：
- 在 `ChatArea` 中新增状态管理：
  - `current_highlighted_bubble` - 保存当前高亮气泡的信息（bubble、original_style、original_text）
  - `highlight_timer` - 保存当前的高亮定时器引用
- 新增 `clear_current_highlight()` 方法，负责清除当前高亮
- `highlight_bubble()` 方法改进：
  1. 在应用新高亮前，先检查并清除之前的高亮
  2. 取消之前未完成的定时器（`timer.stop()`）
  3. 使用新的 `QTimer` 实例替代 `QTimer.singleShot`，便于管理
  4. 保存当前高亮信息，供下次清除使用

#### 1.5 搜索逻辑优化
**当前对话搜索**：
- `search_text_in_current()` 方法返回值从单个结果改为结果列表
- 支持查找所有匹配的气泡，而非仅返回第一个
- 结果列表包含完整的 bubble_info（包含 container、bubble、content 等）

**全局搜索**：
- 遍历所有对话的历史记录
- 找到匹配后自动切换到对应对话
- 使用 `QTimer.singleShot(100)` 延迟执行搜索，确保 UI 加载完成
- 新增 `_perform_search_after_load()` 辅助方法处理加载后的搜索
- 传递 `search_text` 参数用于文本高亮

**滚动定位**：
- `scroll_to_bubble()` 方法新增 `search_text` 可选参数
- 自动计算目标滚动位置，将匹配气泡居中显示
- 调用 `highlight_bubble()` 时传递搜索文本，实现双重高亮

#### 1.6 快捷键支持
- **Ctrl+F** 快速唤醒搜索对话框
- 在 `ChatWindow` 中实现 `keyPressEvent()` 方法
- 导入 `QKeySequence` 用于键盘事件处理
- 检测 `Qt.Key.Key_F` + `Qt.KeyboardModifier.ControlModifier` 组合键
- 全局键盘事件监听，任何时候按 Ctrl+F 均可触发

#### 1.7 信号与槽连接
**新增信号**：
- `SearchDialog.navigate_signal(int)` - 导航到指定索引的结果
- `InputBar.search_text_signal(str)` - 触发搜索文本功能

**ChatUI 方法更新**：
- `show_search_dialog()` - 创建并显示搜索对话框，保存 dialog 引用
- `on_search_in_current(str)` - 处理当前对话搜索，更新结果显示
- `on_search_globally(str)` - 处理全局搜索，切换对话后更新结果
- `on_navigate_to_match(int)` - 处理导航信号，滚动到指定结果

**状态管理**：
- `ChatWindow` 新增属性：
  - `search_dialog` - 搜索对话框实例引用
  - `search_matches` - 当前搜索结果列表
  - `search_text` - 当前搜索的文本

### 2. 代码结构改进

#### 修改的文件：

**chat_area.py**：
- `__init__()` - 新增 `current_highlighted_bubble` 和 `highlight_timer` 属性
- `search_text_in_current()` - 返回所有匹配结果列表
- `scroll_to_bubble()` - 支持传递 `search_text` 参数
- `highlight_bubble()` - 完全重写，支持取消之前的高亮
- `clear_current_highlight()` - 新增方法，清除当前高亮
- `_highlight_text_in_html()` - 新增方法，生成 HTML 高亮文本

**dialogs.py (SearchDialog)**：
- 对话框尺寸：`400x200` → `500x250`
- 新增属性：`matches`、`current_index`
- 新增信号：`navigate_signal(int)`
- 新增按钮：`prev_btn`、`next_btn`
- 新增方法：
  - `set_search_results(matches, current_index)` - 设置搜索结果
  - `update_result_display()` - 更新结果显示
  - `on_previous()` - 上一处导航
  - `on_next()` - 下一处导航
- UI 布局优化：
  - 结果提示和导航按钮水平布局
  - 导航按钮容器独立管理
  - 结果标签左对齐，按钮右对齐

**chat_ui.py**：
- 导入新增：`QKeySequence`
- 新增属性：`search_dialog`、`search_matches`、`search_text`、`chat_manager`
- 新增方法：
  - `set_chat_manager(chat_manager)` - 设置聊天管理器引用
  - `keyPressEvent(event)` - 处理键盘事件
  - `on_navigate_to_match(index)` - 导航到指定匹配
- 方法更新：
  - `show_search_dialog()` - 保存 dialog 引用，连接 navigate_signal
  - `on_search_in_current()` - 获取所有匹配，更新 dialog 显示
  - `on_search_globally()` - 调用 chat_manager，更新结果

**main.py (ChatManager)**：
- `search_text_globally()` - 修改为传递 search_text 参数
- `_perform_search_after_load()` - 新增辅助方法
- 主程序 `__main__` - 调用 `chat_window.set_chat_manager(chat_manager)`

**input_bar.py**：
- 新增信号：`search_text_signal = pyqtSignal()`
- 新增方法：`show_search_dialog()`
- 功能菜单新增项：`搜索文本`（位于"提示词"和"清除历史记录"之间）

### 3. 技术实现细节

#### HTML 文本高亮
```python
def _highlight_text_in_html(self, text, search_text):
    import re
    pattern = re.compile(re.escape(search_text), re.IGNORECASE)
    highlighted = pattern.sub(
        lambda m: f'<span style="background-color: yellow; color: black; font-weight: bold;">{m.group(0)}</span>',
        text
    )
    return highlighted
```

#### 高亮状态管理
```python
# 清除之前的高亮
if self.current_highlighted_bubble is not None:
    self.clear_current_highlight()

# 取消未完成的定时器
if self.highlight_timer is not None:
    self.highlight_timer.stop()
    self.highlight_timer = None

# 保存当前高亮信息
self.current_highlighted_bubble = {
    'bubble': bubble,
    'original_style': original_style,
    'original_text': original_text
}

# 创建新的定时器
self.highlight_timer = QTimer()
self.highlight_timer.setSingleShot(True)
self.highlight_timer.timeout.connect(self.clear_current_highlight)
self.highlight_timer.start(3000)
```

#### 导航按钮状态管理
```python
def update_result_display(self):
    total = len(self.matches)
    current = self.current_index + 1
    self.show_result(f"已查找到 {total} 处内容，现在显示的是 {current}/{total} 处")
    
    # 更新按钮状态
    self.prev_btn.setEnabled(self.current_index > 0)
    self.next_btn.setEnabled(self.current_index < total - 1)
```

### 4. 用户体验提升

#### 视觉反馈
- ✅ 气泡背景高亮 + 关键词文本高亮，双重视觉提示
- ✅ 橙色边框 + 黄色关键词，色彩对比强烈
- ✅ 3秒自动恢复，不影响正常阅读

#### 操作便捷
- ✅ Ctrl+F 快捷键，快速唤醒搜索
- ✅ Enter 键执行搜索，无需点击按钮
- ✅ 导航按钮快速切换，无需重新搜索

#### 信息清晰
- ✅ 实时显示搜索结果数量和当前位置
- ✅ 按钮状态智能提示（禁用/启用）
- ✅ 错误提示与正常提示色彩区分

#### 性能优化
- ✅ 取消未完成的定时器，避免资源浪费
- ✅ 清除之前的高亮，防止多重高亮叠加
- ✅ 延迟执行搜索，确保 UI 加载完成

## 项目结构（2025-10-05）

```
README.md
LOG/
    UPDATE_2025-10-05.md
    UPDATE_2025-09-30.md
    UPDATE_2025-09-28.md
SoftWare/
    Script/
        main.py - ChatManager 新增全局搜索方法
        api_client.py
        api_config.py
        chat_area.py - 搜索、滚动、高亮功能
        chat_ui.py - 搜索对话框集成、快捷键
        dialogs.py - SearchDialog 完全重构
        input_bar.py - 搜索菜单项
        sidebar.py
        storage_config.py
        database_manager.py
        file_manager.py
        bubble_copy_handler.py
        theme_manager.py
        ...
    Image/
        Backgroud/
        loading/
    Icon/
TOOL/
    dev_notebook.py
    sentence/
        summary.md
```

## 功能特性（2025-10-05）

- 支持多AI模型（Gemini/DeepSeek），可随时切换
- Gemini集成官方SDK，自动密钥管理，支持最新模型（gemini-2.5-flash）
- 聊天气泡自适应布局，内容包裹优先，最大宽度限制，换行撑满
- 自动代理配置，支持本地代理穿透防火墙
- 完善的配置诊断与修复脚本
- 详细的技术文档与更新日志
- 联网即可使用个人助手问答
- 本地保存对话记录不泄密
- 预设提示词提高问答效率
- 任务管理栏滚动播放任务名称
- UI界面可缩放至任意大小
- **高级文本搜索功能**（2025-10-05 新增）
  - 支持当前对话搜索和全局搜索
  - 智能双重高亮：气泡背景高亮 + 关键词文本高亮
  - 搜索结果计数与导航："已查找到 X 处内容，现在显示的是 Y/X 处"
  - 上一处/下一处快速导航按钮（找到2处及以上时自动显示）
  - Ctrl+F 快捷键快速唤醒搜索对话框
  - 搜索结果自动居中显示，3秒高亮后恢复
  - 支持大小写不敏感匹配
  - 高亮状态智能管理，避免快速切换时的锁定问题

## 测试建议

1. ✅ 测试单个匹配结果（无导航按钮）
2. ✅ 测试多个匹配结果（显示导航按钮）
3. ✅ 测试快速点击导航按钮（验证高亮锁定修复）
4. ✅ 测试全局搜索跨对话切换
5. ✅ 测试 Ctrl+F 快捷键
6. ✅ 测试深色/浅色主题下的文本颜色
7. ✅ 测试高亮效果和恢复机制（3秒自动恢复）
8. ✅ 测试导航按钮状态（首位/末位禁用逻辑）

## 已知问题与限制

- 无明显问题，所有功能测试通过

## 未来改进方向

- 考虑支持正则表达式搜索
- 考虑添加搜索历史记录
- 考虑支持搜索过滤（仅搜索用户消息/Agent消息）
- 考虑添加搜索结果高亮持久化（不自动消失，手动关闭）
