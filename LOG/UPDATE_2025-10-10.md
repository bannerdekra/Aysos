# 2025-10-10 Gemini 视频理解与文件类型重构

## 📋 更新概述
完成了 Gemini 视频理解功能的完整实现，并重构了文件类型支持策略，现在**仅支持图片、PDF、视频**三种多模态文件类型，移除了对 TXT、DOCX、CSV 等文档类型的支持。

## 🎯 核心功能

### 1. Gemini 视频理解支持
- **支持的视频格式**：MP4, MOV, MPEG, AVI, WebM
- **上传策略**：所有视频文件自动使用 File API 上传（无论大小）
- **大小限制**：单个视频文件最大 2GB
- **服务器保留**：上传后在 Gemini 服务器保留 48 小时
- **多轮引用**：支持在多轮对话中引用同一视频文件

### 2. 严格的文件类型过滤

#### ✅ 支持的文件类型（14种MIME类型）

**图片文件**（6种）：
- 格式：JPEG, PNG, GIF, WebP, HEIC, HEIF
- MIME类型：`image/jpeg`, `image/png`, `image/gif`, `image/webp`, `image/heic`, `image/heif`
- 上传策略：< 20MB 内嵌上传，≥ 20MB 使用 File API

**PDF文件**（1种）：
- 格式：PDF
- MIME类型：`application/pdf`
- 上传策略：< 20MB 内嵌上传，≥ 20MB 使用 File API

**视频文件**（7种）：
- 格式：MP4, MOV, MPEG, AVI, WebM
- MIME类型：`video/mp4`, `video/mov`, `video/mpeg`, `video/avi`, `video/quicktime`, `video/x-msvideo`, `video/webm`
- 上传策略：**强制使用 File API**（无论大小）

#### ❌ 移除的文件类型
- TXT 文本文件
- DOCX/DOC 文档
- CSV 数据文件
- 代码文件（.py, .js, .java, .cpp 等）
- 音频文件（.mp3, .wav 等）
- 其他非多模态文件类型

### 3. 智能上传路径选择

| 文件类型 | 文件大小 | 上传方式 | 说明 |
|---------|---------|---------|------|
| 图片 | < 20MB | 内嵌上传（Part.from_bytes） | 快速，仅当次请求有效 |
| 图片 | ≥ 20MB | File API | 上传到服务器，保留48小时 |
| PDF | < 20MB | 内嵌上传 | 快速，仅当次请求有效 |
| PDF | ≥ 20MB | File API | 上传到服务器，保留48小时 |
| 视频 | **任意大小** | **File API（强制）** | 视频必须上传到服务器 |
| 任意 | > 2GB | ❌ 拒绝 | 超过硬限制 |
| 不支持类型 | - | ❌ 跳过 | 自动过滤 |

### 4. 双重文件验证机制
1. **第一层：文件扩展名检查**
   - `ALLOWED_EXTENSIONS = {'.pdf', '.png', '.jpg', '.jpeg', '.webp', '.heic', '.heif', '.mp4', '.mov', '.mpeg', '.avi', '.webm'}`

2. **第二层：MIME 类型白名单检查**
   - `ALLOWED_MIME_TYPES = IMAGE_MIME_TYPES + [PDF_MIME_TYPE] + VIDEO_MIME_TYPES`
   - 不在白名单中的文件会被跳过并记录日志

## 📝 修改的文件

### 1. `gemini_context_manager.py` - 核心重构

#### 新增常量定义（文件顶部）
```python
# 视频文件MIME类型（必须走 File API）
VIDEO_MIME_TYPES = [
    'video/mp4', 'video/mov', 'video/mpeg', 'video/avi',
    'video/quicktime', 'video/x-msvideo', 'video/webm'
]

# 图像文件MIME类型（小文件走内嵌，大文件走 File API）
IMAGE_MIME_TYPES = [
    'image/jpeg', 'image/png', 'image/gif', 
    'image/webp', 'image/heic', 'image/heif'
]

# PDF文件MIME类型
PDF_MIME_TYPE = 'application/pdf'

# 所有允许的MIME类型（仅支持图片、PDF、视频）
ALLOWED_MIME_TYPES = IMAGE_MIME_TYPES + [PDF_MIME_TYPE] + VIDEO_MIME_TYPES
```

#### 重构 `_get_mime_type()` 方法
- 优先使用 `mimetypes` 库自动检测
- 针对视频、图片、PDF 进行精确的手动映射
- 移除了对 TXT、代码文件、音频等的支持
- 返回 `application/octet-stream` 作为默认值（后续会被过滤）

#### 优化 `send_message_with_files()` 方法
- 添加 `MAX_INLINE_SIZE = 20MB` 和 `MAX_FILE_SIZE = 2GB` 常量
- **核心过滤逻辑**：检查 MIME 类型是否在 `ALLOWED_MIME_TYPES` 白名单中
- **视频处理**：`is_video = mime_type in VIDEO_MIME_TYPES`，强制走 File API
- **大文件处理**：`is_large_file = file_size >= MAX_INLINE_SIZE`，使用 File API
- **小文件处理**：图片和 PDF < 20MB，使用内嵌上传
- 移除了原有的 TXT、DOCX 等特殊处理逻辑

#### 更新类属性
```python
ALLOWED_EXTENSIONS = {'.pdf', '.png', '.jpg', '.jpeg', '.webp', 
                     '.heic', '.heif', '.mp4', '.mov', '.mpeg', 
                     '.avi', '.webm'}
```

### 2. `input_bar.py` - UI 支持更新
更新文件选择对话框过滤器：
```python
file_dialog.setNameFilter(
    "支持的文件 (*.jpg *.jpeg *.png *.pdf *.webp *.heic *.heif *.mp4 *.mov *.mpeg *.avi *.webm);;"
    "图片文件 (*.jpg *.jpeg *.png *.webp *.heic *.heif);;"
    "文档文件 (*.pdf);;"
    "视频文件 (*.mp4 *.mov *.mpeg *.avi *.webm);;"
    "所有文件 (*.*)"
)
```

### 3. `chat_area.py` - 气泡文件引用显示
新增功能：在用户和 Agent 气泡底部显示文件引用信息
- **用户气泡**：显示临时文件名（📄 图标）
- **Agent 气泡**：显示持久文件引用（🔗 图标）
- 文件名紧贴气泡底部，灰色小字体显示
- 支持多个文件同时显示

## 🧪 测试验证

### 新增测试文件：`test_video_support.py`
包含 4 个测试套件：

1. **测试 1：MIME 类型检测**
   - 验证 14 种允许的 MIME 类型
   - 验证不支持的类型被正确拒绝
   - ✅ 全部通过

2. **测试 2：文件扩展名过滤**
   - 验证 12 种允许的扩展名
   - 按类型分类显示（图片6种，视频5种，文档1种）
   - ✅ 全部通过

3. **测试 3：文件上传路径选择逻辑**
   - 验证小图片 → 内嵌上传
   - 验证大图片 → File API
   - 验证小视频 → File API（强制）
   - 验证大视频 → File API（强制）
   - 验证 TXT → 跳过
   - ✅ 全部通过

4. **测试 4：文件大小限制**
   - 验证 < 20MB → 内嵌上传
   - 验证 ≥ 20MB → File API
   - 验证 > 2GB → 拒绝
   - ✅ 全部通过

**测试结果**：所有测试 100% 通过 ✅

## 📊 日志输出示例

### 成功上传视频
```
📁 视频文件使用 File API: sample.mp4 (15.50 MB)
  → File API 上传成功 (文件将在服务器保留48小时)
  → 文件已上传至 Gemini，ID: files/abc123xyz
📤 发送消息（含 1 个文件）到对话 conv_123
✅ 收到回复: 这个视频展示了...
```

### 跳过不支持的文件
```
❌ 文件类型不受支持，跳过: document.txt (MIME: text/plain)
⚠️ 没有成功处理任何文件，但仍使用 Part 结构发送文本
```

### 内嵌上传小图片
```
🖼️ 内嵌上传小文件: photo.jpg (MIME: image/jpeg, 2.30 MB)
  → 内嵌上传成功 (MIME: image/jpeg)
📤 发送消息（含 1 个文件）到对话 conv_123
```

### 文件过大被拒绝
```
❌ 文件过大（> 2GB），无法上传: huge_video.mp4
```

## 📄 文档更新

### 新增文档：`GEMINI_VIDEO_SUPPORT.md`
完整的实现文档，包含：
- 功能概述与支持的文件类型
- 详细的文件处理流程图
- 使用示例与代码片段
- 日志输出说明
- 配置说明（大小阈值、MIME 白名单、生命周期）
- 错误处理与注意事项
- 总结与最佳实践

## 🎯 技术亮点

1. **精准的类型控制**
   - 通过 MIME 白名单严格限制文件类型
   - 双重验证机制确保安全性

2. **智能的上传策略**
   - 视频强制 File API（符合 Gemini 最佳实践）
   - 小文件内嵌（快速响应）
   - 大文件 File API（避免超时）

3. **健壮的错误处理**
   - 不支持的文件自动跳过
   - 清晰的日志输出
   - 单个文件失败不影响其他文件

4. **优秀的用户体验**
   - 气泡底部显示文件引用
   - 临时/持久文件清晰标识
   - 图标化显示（📄/🔗）

## 📈 性能与限制

### 文件大小限制
- **内嵌上传上限**：20 MB
- **硬限制**：2 GB
- **建议视频大小**：500 MB 以内（更快上传）

### 文件生命周期
- **File API 上传文件**：服务器保留 48 小时
- **内嵌上传文件**：仅当次请求有效
- **自动清理**：可调用 `cleanup_expired_files()` 方法

### API 配额
- File API 调用计入 Gemini API 配额
- 视频处理需要额外的处理时间
- 大文件上传需要稳定的网络连接

## 🔄 与之前的对比

### 之前（2025-10-09）
- 支持图片、PDF
- 支持 TXT、DOCX 等文档类型
- 文件大小统一按 20MB 判断
- 所有文件走相同上传路径

### 现在（2025-10-10）
- ✅ 支持图片、PDF、**视频**
- ❌ 移除 TXT、DOCX 等文档类型
- ✅ 视频强制走 File API
- ✅ 智能选择上传路径（内嵌 vs File API）
- ✅ 严格的 MIME 类型白名单
- ✅ 2GB 硬限制保护
- ✅ 气泡底部显示文件引用

## 🚀 使用场景

### 场景 1：视频内容分析
```python
"分析这个视频中的主要动作"
+ video.mp4 (100MB)
→ 自动使用 File API 上传
→ Gemini 返回详细的视频分析
```

### 场景 2：多模态联合分析
```python
"对比图片和视频中的人物服装"
+ photo.jpg (5MB) - 内嵌上传
+ video.mp4 (50MB) - File API 上传
→ Gemini 同时分析图片和视频
```

### 场景 3：PDF 文档理解
```python
"总结这份报告的要点"
+ report.pdf (15MB) - 内嵌上传
→ Gemini 提取文本并总结
```

## ⚠️ 注意事项

1. **视频处理时间**：视频上传后 Gemini 需要几秒到几分钟进行处理
2. **网络要求**：视频上传需要稳定的网络连接
3. **代理设置**：上下文管理器已处理代理环境变量隔离
4. **文件格式**：确保视频编码格式被 Gemini 支持（H.264 推荐）

## 🎉 总结

本次更新实现了：
- ✅ 完整的 Gemini 视频理解支持
- ✅ 精准的文件类型控制（仅图片、PDF、视频）
- ✅ 智能的上传路径选择
- ✅ 双重文件验证机制
- ✅ 健壮的错误处理
- ✅ 清晰的日志输出
- ✅ 气泡文件引用显示
- ✅ 全面的测试验证
- ✅ 完整的文档说明

现在 Agent 可以完美支持图片、PDF 和视频的多模态分析！🎬📄🖼️

## 📚 相关文档
- `GEMINI_VIDEO_SUPPORT.md` - 视频支持完整文档
- `test_video_support.py` - 测试套件
- `gemini_context_manager.py` - 核心实现

## 🔮 后续计划
- 考虑添加音频文件支持（如需要）
- 优化大视频文件的上传进度显示
- 添加视频缩略图预览功能
- 支持视频片段截取上传
