```markdown
# UPDATE — 2025-10-15

时间：2025-10-15  
版本：V1.0.5 → V1.0.6

## 一、今日工作摘要
- 完成 Stable Diffusion 创作控制面板的精度与交互优化（CFG 支持 0.5 步长、移除数值框上下按钮、滚轮微调精度调整）。
- 修复并统一所有 SD WebUI 请求在存在系统代理（http_proxy / https_proxy）时的代理绕过问题，避免代理将本地请求（127.0.0.1:7860）劫持到外部代理导致的 502/Bad Gateway 错误。
- 为图像生成新增模型选择与自动刷新（通过 `/sdapi/v1/sd-models` 拉取可用模型），并在生成逻辑中新增模型切换接口（通过 `/sdapi/v1/options` 设置）。
- 将“生成图片”按钮扩展为包含“🎨 创作调整（打开控制面板）”与“⚡ 快速生成（直接触发）”的弹出菜单。
- 压缩并优化提示词编辑区布局（更小的文本区域，便于快速切换与多行提示词编辑）。

## 二、主要功能与改进要点（对比 2025-10-11）

总体说明：2025-10-11（V1.0.5）侧重于 Gemini 多模态能力、文件上传稳定性与视频支持；本次 2025-10-15（V1.0.6）是在此基础上，着重完善 Stable Diffusion 本地生图 UX 与网络稳定性（代理绕过与模型管理）。

1) 代理与网络稳定性
   - 10.11 状态：主要修复 Gemini 上传与 File API 的稳定性，未覆盖到本地 SD WebUI 被系统代理劫持的场景。
   - 10.15 改进：所有与 SD WebUI 的 requests 调用都显式加入代理绕过参数：
     ```py
     proxies={'http': None, 'https': None}
     ```
     该改动避免了当用户启用全局代理（如 127.0.0.1:7890）时，本地 SD 请求被转发到代理而返回 502 的问题。

2) 创作控制面板（CreationPanel）
   - 10.11 状态：未集成生图精细控制面板（只列出未来目标）。
   - 10.15 改进：新增 `creation_panel.py`，实现完整的参数面板，包含：
     - 采样器、调度器、步数、CFG（支持 0.5 步长显示）、种子、宽/高、批次数、clip_skip、负面提示词、模型选择等。
     - CFG 内部使用滑动条的 10-300（对应 1.0-30.0），并采用如下转换保证 0.5 精度：
       ```py
       value = round(slider_value / 10.0 * 2) / 2
       ```
     - 所有 SpinBox/DoubleSpinBox 移除上下按钮（`setButtonSymbols(NoButtons)`），界面更简洁。
     - 滚轮精度：步数/宽度/高度滚轮步进为 1；CFG 滚轮每次内部步进 5（相当 0.5）。

3) 生成流程与 UI 行为
   - 10.11 状态：关注文件上传、气泡显示与视频支持，尚未完善生成按钮交互。
   - 10.15 改进：将主界面“生成图片”按钮替换为带菜单的触发器，提供“创作调整（打开控制面板）”与“快速生成（直接触发）”两种路径，便于快捷生成与精细调整并存。

4) 模型管理
   - 10.11 状态：多模型支持侧重 Gemini/DeepSeek；未实现 SD WebUI 本地模型的动态列表。
   - 10.15 改进：在 `image_generator.py` 中新增 `refresh_models()` 与 `switch_model()`，通过 `/sdapi/v1/sd-models` 拉取模型并填充下拉菜单，切换模型会调用 `/sdapi/v1/options` 设置当前模型（并在生成请求前确认）。

5) 文档与日志
   - 10.11 已完成 Gemini 视频支持文档与若干测试用例。
   - 10.15 新增本次更新日志（本文件），并在 README 中增加 2025-10-15 的简短条目与版本号提升。

## 三、已修改/新增的主要文件
- 新增：
  - `SoftWare/Script/creation_panel.py` — 创作控制面板 UI 与参数绑定（CFG 0.5 支持、无按钮 SpinBox、滚轮精度）
- 修改：
  - `SoftWare/Script/image_generator.py` — 为所有 SD WebUI 请求添加代理绕过；新增 `refresh_models()`、`switch_model()`、改进 `generate_image_with_progress()` 使用模型切换。
  - `SoftWare/Script/input_bar.py` — 将“生成图片”改为带菜单的按钮，并添加打开创作控制面板的入口。
  - `SoftWare/Script/main.py` — 添加处理自定义参数生成的工作线程类/控制器。

## 四、验证步骤（回归清单）
1. 重启应用。
2. 打开主界面，点击“生成图片”按钮，确认弹出菜单包含“🎨 创作调整”和“⚡ 快速生成”。
3. 打开“创作调整”：
   - 确认 CFG 支持 7.5、8.0 等 0.5 步长值；输入 7.1/7.3 时会四舍五入到最近的 0.5。
   - 所有数值框右侧无上下箭头按钮。
   - 将光标置于宽度/高度数值框，使用鼠标滚轮每次改变 1 像素。
4. 测试在启用系统代理（例如 http_proxy 指向 127.0.0.1:7890）时仍能正常与本地 SD WebUI 通信，不出现 502 错误。
5. 在模型下拉菜单中选择另一个模型，生成时确认服务端加载该模型（或至少接受该参数）。

## 五、已知限制与后续计划
- 若 SD WebUI 对模型切换存在长期加载延迟，可能需要在 UI 中加入模型加载状态提示与超时重试机制（下一步）。
- 为了更好支持高级用例，计划加入参数预设（保存/加载）与参数历史记录。

---

结束。
```