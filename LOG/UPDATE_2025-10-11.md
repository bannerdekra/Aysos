# UPDATE — 2025-10-11

时间：2025-10-11  
版本：V1.0.4 → V1.0.5

## 一、今日工作摘要
- 完成 Gemini 多模态能力强化与稳定性修复，确保图片 / PDF / 视频（MP4/MOV/MPEG/AVI/WEBM）可被正确识别与分析。
- 修复并稳固文件上传与 File API 使用逻辑（包括大文件与视频的等待/轮询机制），解决 File 未处于 ACTIVE 即使用导致的 400 错误。
- 修复多处与 SDK 兼容性相关的参数/类型问题（移除不支持参数，统一使用 `file=` 上传并确保返回类型与 chat API 兼容）。
- 完善存储与历史恢复逻辑，支持消息级附件持久化（在历史列表、气泡下方显示并可预览）。
- 修复并强化对话标题生成逻辑：限制标题长度、清理非法字符、改为随机选取最终标题并只输出最终标题到控制台。
- UI/UX 改进：附件栏样式放大、文件 chip 交互优化、用户气泡底部显示小标签（持久化显示，点击预览）、deepseek 模型下禁用附件上传。
- 修复 Windows 控制台编码问题（移除/替换 emoji 导致的 GBK 错误）。
- 添加自动化测试脚本与工具（附件上传、视频识别、历史恢复等测试），并记录测试报告与验证结果。
- 文档更新：README、GEMINI_VIDEO_SUPPORT.md、多个 LOG 文档及快速参考文件已同步。

## 二、主要修复与新增（要点）
1. Gemini 文件上传与使用
   - 统一使用新版 SDK 上传接口（`client.files.upload(file=...)`）。
   - 上传后轮询文件状态，等待 `ACTIVE` 后再用于模型请求（最大等待、超时与失败处理）。
   - 视频文件强制走 File API（支持最大 2GB），小文件（图片/PDF <20MB）内嵌发送。

2. 内容发送与类型兼容
   - 修正 `chat.send_message` 调用方式：将 Parts 列表作为单个参数传入（`chat.send_message(contents)`），确保 SDK v1.x 正确解析。
   - 统一 File/Part 类型，避免类型不匹配 ValueError。

3. 存储与历史恢复
   - message 存储扩展，支持 `files` 字段（持久化文件路径/引用）。
   - 历史恢复容错：兼容旧格式字符串与 dict 两种存储格式，避免 `'str' object has no attribute 'get'` 错误。
   - 修复点击任务导致历史被覆盖问题：严格解析存储文件格式，标题不作为消息内容注入。

4. UI 改进
   - 在用户气泡下方显示小文件标签（小号样式，左对齐，点击可预览；若源路径不存在显示提示但保留标签）。
   - 附件栏 chip 尺寸增大、视觉优化，并支持即时显示“后续引用”灰→绿状态变化。
   - 选择 deepseek 模型时禁用“+”按钮并显示禁用提示。

5. 标题生成
   - 仅在控制台输出最终选定的对话标题（随机从 AI 生成的候选中选取），移除冗余长文本打印。
   - 标题清洗：去换行、移除非法文件名字符并截断，避免文件重命名失败。

6. 测试与文档
   - 新增 `TOOL/test_attachment_features.py`、`test_video_support.py`、`quick_video_test.py` 等测试脚本。
   - 更新 README（V1.0.4 信息）与多份 LOG 文档，新增视频支持文档 `GEMINI_VIDEO_SUPPORT.md`。

## 三、已修改/新增的主要文件
- 修改（主要）：
  - SoftWare/Script/gemini_context_manager.py
  - SoftWare/Script/input_bar.py
  - SoftWare/Script/chat_area.py
  - SoftWare/Script/main.py
  - SoftWare/Script/api_client.py
  - SoftWare/Script/api_config.py
  - SoftWare/Script/file_manager.py
  - SoftWare/Script/storage_config.py
  - SoftWare/Script/database_manager.py
- 新增/更新测试与文档：
  - TOOL/test_attachment_features.py
  - test_video_support.py
  - LOG/UPDATE_2025-10-11.md (本文件)
  - GEMINI_VIDEO_SUPPORT.md
  - MULTIMODAL_TEST_REPORT.md
  - UI_FIXES_V2.md

## 四、验证步骤（快速回归）
1. 重启应用。
2. 点击“+”选择三个测试文件（test-video.mp4, test-picture.png, test-pdf.pdf），分别以临时模式发送并等待处理完成（视频需等待 ACTIVE 状态）。
3. 确认控制台输出仅显示 “[OK] 对话标题: <简短标题>”。
4. 检查用户气泡下是否出现小文件标签，点击可预览（若文件已移动，显示“文件已被移动/不可预览”提示，标签保留）。
5. 切换侧栏任务，确认历史加载正确且 AI 回复未被标题覆盖。
6. 切换到 deepseek 模型，确认“+”按钮灰化不可用。
7. 运行测试脚本： `python TOOL\test_attachment_features.py`，确认测试通过。

## 五、已知限制与后续计划
- 某些极端大视频上传与处理依赖 Gemini 服务排队，可能需更长时间；已设置超时与友好提示，后续会优化进度展示。
- 计划：加入视频缩略图预览、上传进度条、更多格式/音频支持与更多模型接入（Claude/GPT等）。

## 六、日志与合规
- 今日变更与提交已记录于 LOG 目录，后续每次提交需继续在 LOG 中留档（遵循项目开发准则）。

---

结束。

## 未解决问题
1. 点击对话栏中的任务名会清空正在显示的聊天界面对话内容
2. 用户气泡下的标签无法正确预览该文件