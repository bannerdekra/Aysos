# 更新日志 - 2025-10-19

## 🆕 功能更新

### 1. 长文本智能折叠功能 ✅

#### ✨ 功能概述

新增 Agent 回复的长文本自动折叠功能，提升长对话的浏览体验。

### 📋 主要特性

1. **自动检测长文本**
   - Agent 回复超过 500 字符（可配置）时，自动显示展开/收起按钮
   - 用户消息不受影响

2. **智能折叠显示**
   - 收起状态：显示前 300 字符（可配置）+ "..."
   - 展开状态：显示完整文本
   - 一键切换，流畅自然

3. **用户自定义配置**
   - 在设置中可调整折叠阈值（100-5000 字符）
   - 可设置收起时显示的字符数（50-1000 字符）
   - 配置自动保存，下次启动生效

4. **保持原有功能**
   - 文本可选择和复制
   - 复制按钮正常工作
   - 气泡样式不变
   - 历史记录正常加载

### 🎯 使用场景

- **长代码片段**：折叠代码，仅显示前几行
- **详细说明**：折叠长篇文字，需要时展开
- **历史浏览**：快速浏览对话，不被长文本占据屏幕

### 🔧 技术实现

#### 核心组件

**CollapsibleBubbleLabel**
- 继承 QWidget，包含文本标签和按钮
- 自动检测文本长度
- 支持折叠/展开切换
- 保持文本可选择性

**配置持久化**
- 保存到 `theme_settings.json`
- 应用启动时自动加载
- 修改后实时生效

#### 修改的文件

1. **chat_area.py**（约 +100 行）
   - 新增 `CollapsibleBubbleLabel` 类
   - 创建 `CopyableCollapsibleBubbleLabel`
   - 更新 `update_chat_display()` 和 `add_history_bubble()`
   - 添加配置加载函数

2. **dialogs.py**（约 +90 行）
   - 添加 "长文本折叠设置" 配置区域
   - 实现配置保存和加载方法
   - 添加 SpinBox 控件

### 📸 界面展示

```
收起状态：
┌─────────────────────────────┐
│ 这是一段很长的文本内容...   │
│ ▼ 展开全文                  │
└─────────────────────────────┘

展开状态：
┌─────────────────────────────┐
│ 这是一段很长的文本内容      │
│ 包括所有详细说明...         │
│ ▲ 收起                      │
└─────────────────────────────┘
```

### ⚙️ 设置位置

**设置 → 通用设置 → 长文本折叠设置**

- 折叠阈值（字符数）：[100-5000]
- 收起时显示字符数：[50-1000]

### ✅ 测试验证

- ✅ 短文本（< 500 字符）：不显示折叠按钮
- ✅ 长文本（> 500 字符）：自动收起，显示按钮
- ✅ 展开/收起切换：流畅无卡顿
- ✅ 文本复制：正常工作
- ✅ 历史记录：正确应用折叠规则
- ✅ 配置保存：重启后生效

### 📝 配置文件示例

```json
{
  "collapse_threshold": 500,
  "preview_length": 300,
  "dark_mode_enabled": false,
  "auto_dark_mode": false,
  "custom_background_path": "",
  "is_video_background": false
}
```

### 🎨 按钮样式

- 🔴 红色渐变背景（#FF6B6B → #EE5A6F）
- ⚪ 白色文字，14px 圆角
- 🖱️ Hover 时边框高亮 (#FF6B6B) + 轻微放大（scale: 1.02）
- 💡 按钮文字：展开全文 ▼ / 收起 ▲

---

## 🐛 Bug 修复

### 2. 对话框背景透明问题 ✅

#### 🔍 问题描述

**症状**：当从动态壁纸切换到静态壁纸后，原本白色背景的设置对话框会变成透明或显示主窗口的背景图片。

**影响范围**：所有子对话框（设置、文件选择、消息框等）

**发现时间**：2025-10-19

#### 🔬 根本原因

1. **样式继承机制**：PyQt6 的 `setStyleSheet()` 方法默认会向下继承到所有子组件
2. **主窗口样式**：`chat_ui.py` 中的 `set_background_static()` 和 `play_video_background()` 使用 `self.setStyleSheet()` 设置背景
3. **影响对话框**：对话框（QDialog）作为主窗口的子组件，继承了父窗口的样式，导致背景变透明或显示背景图片

**代码示例**（问题代码）：
```python
# 错误：样式会影响所有子组件
self.setStyleSheet("background-image: url('wallpaper.jpg');")
```

#### ✅ 修复方案

**核心思路**：使用 CSS 选择器精确定位主窗口，避免样式继承到子组件

**修复步骤**：

1. **设置对象名称**（`chat_ui.py` 第 52 行）：
```python
def __init__(self):
    super().__init__()
    self.setWindowTitle('Agent')
    
    # 设置对象名称，用于样式选择器
    self.setObjectName("ChatWindow")
```

2. **使用 CSS 选择器 - 静态背景**（`chat_ui.py` 第 297-310 行）：
```python
def set_background_static(self, path):
    if path and os.path.exists(path):
        # 使用 QWidget#ChatWindow 选择器，只影响主窗口
        self.setStyleSheet(f"""
            QWidget#ChatWindow {{
                background-image: url('{image_path_escaped}');
                background-repeat: no-repeat;
                background-position: center;
                border-radius: 10px;
            }}
        """)
    else:
        # 清除背景时也使用选择器
        self.setStyleSheet("QWidget#ChatWindow { background: white; }")
```

3. **使用 CSS 选择器 - 视频背景**（`chat_ui.py` 第 226 行）：
```python
def play_video_background(self, video_path):
    # 清除主窗口的静态背景（只影响主窗口）
    self.setStyleSheet("QWidget#ChatWindow { background: transparent; }")
```

#### 🎯 技术细节

**CSS 选择器原理**：
- `QWidget { ... }` → 影响所有 QWidget 及其子类（包括 QDialog）❌
- `QWidget#ChatWindow { ... }` → 只影响对象名为 "ChatWindow" 的 QWidget ✅

**PyQt6 样式选择器支持**：
- `#ObjectName` - 按对象名称匹配
- `.ClassName` - 按类名匹配
- `Type#Name` - 按类型和对象名组合匹配

#### 📝 修改文件

- `SoftWare/Script/chat_ui.py` - 主窗口背景管理
  - 第 52 行：添加 `setObjectName("ChatWindow")`
  - 第 226 行：修改视频背景样式表
  - 第 297-310 行：修改静态背景样式表

#### 🧪 测试场景

测试项目：
1. ✅ 动态壁纸 → 打开设置 → 对话框背景为白色
2. ✅ 动态壁纸 → 切换到静态壁纸 → 打开设置 → 对话框背景仍为白色
3. ✅ 静态壁纸 → 切换到动态壁纸 → 打开设置 → 对话框背景仍为白色
4. ✅ 多次切换壁纸类型 → 对话框始终保持白色背景
5. ✅ 所有子对话框（文件选择、消息框）背景正常

#### 📚 参考资料

- PyQt6 官方文档：[Qt Style Sheets Reference](https://doc.qt.io/qt-6/stylesheet-reference.html)
- CSS 选择器语法：[Qt Style Sheets - Selector Types](https://doc.qt.io/qt-6/stylesheet-syntax.html#selector-types)

---

## 📋 完整功能说明

### 长文本折叠功能详情

### 🔍 注意事项

1. **仅对 Agent 回复生效**
   - 用户消息不会被折叠
   - 保持对话自然流畅

2. **向后兼容**
   - 不影响现有对话记录
   - 历史记录自动应用折叠

3. **性能优化**
   - 折叠/展开是纯 UI 操作
   - 不重新渲染气泡

### 🚀 未来优化

1. 智能折叠点（段落边界）
2. 代码块独立折叠
3. 记忆折叠状态
4. 可视化进度指示

---

## 🐛 对话框背景透明问题修复

### 🔍 问题描述

**症状**：当从动态壁纸切换到静态壁纸后，设置对话框等弹窗的白色背景会变成透明或显示主窗口的背景图片。

**影响范围**：
- 设置对话框（ChatConfigDialog）
- DSN 配置对话框（DSNConfigDialog）
- 其他所有基于 QDialog 的弹窗

**复现步骤**：
1. 启动程序并加载动态壁纸
2. 打开设置对话框，背景正常显示为白色
3. 切换到静态壁纸
4. 再次打开设置对话框，背景变为透明/显示背景图

### 🔬 根本原因

**问题根源**：PyQt6 的样式表继承机制

```python
# 问题代码（修复前）
def set_background_static(self, path):
    ...
    self.setStyleSheet(f"background-image: url('{image_path_escaped}');...")
    # ❌ 这个样式会继承到所有子组件，包括对话框
```

**继承链**：
```
ChatWindow (QWidget)
  └─ setStyleSheet("background-image: ...")
       └─ 影响所有子组件
            └─ QDialog 对话框
                 └─ 失去默认白色背景
```

### ✅ 解决方案

**核心思路**：使用 CSS 选择器精确定位，只让样式作用于主窗口

#### 1. 设置对象名称

```python
# chat_ui.py __init__() 方法
def __init__(self):
    super().__init__()
    self.setWindowTitle('Agent')
    
    # ✅ 设置对象名称，用于样式选择器
    self.setObjectName("ChatWindow")
    ...
```

#### 2. 修改静态背景样式表

```python
# chat_ui.py set_background_static() 方法（修复后）
def set_background_static(self, path):
    ...
    if path and os.path.exists(path):
        ...
        # ✅ 使用 QWidget#ChatWindow 选择器，只影响主窗口
        self.setStyleSheet(f"""
            QWidget#ChatWindow {{
                background-image: url('{image_path_escaped}');
                background-repeat: no-repeat;
                background-position: center;
                border-radius: 10px;
            }}
        """)
    else:
        # ✅ 清除背景时也使用选择器
        self.setStyleSheet("QWidget#ChatWindow { background: white; }")
```

#### 3. 修改视频背景样式表

```python
# chat_ui.py play_video_background() 方法（修复后）
def play_video_background(self, video_path):
    ...
    # ✅ 清除静态背景，使用选择器避免影响对话框
    self.setStyleSheet("QWidget#ChatWindow { background: transparent; }")
```

### 📚 技术原理

**CSS 选择器语法**：
- `QWidget { ... }` - 匹配所有 QWidget 及其子类（包括对话框）
- `QWidget#ChatWindow { ... }` - 仅匹配对象名为 "ChatWindow" 的 QWidget

**选择器优先级**：
```
#ObjectName > .ClassName > ElementType
```

### 🧪 测试验证

**测试场景**：
- ✅ 动态壁纸 → 打开对话框 → 背景白色
- ✅ 动态壁纸 → 切换到静态壁纸 → 打开对话框 → 背景仍为白色
- ✅ 静态壁纸 → 切换到动态壁纸 → 打开对话框 → 背景仍为白色
- ✅ 多次切换壁纸类型 → 对话框始终保持白色背景
- ✅ 不同对话框（设置、DSN 配置）→ 背景一致

### 📝 修改的文件

**chat_ui.py**
- `__init__()` 方法：添加 `setObjectName("ChatWindow")`（+1 行）
- `set_background_static()` 方法：使用 CSS 选择器（~15 行修改）
- `play_video_background()` 方法：使用 CSS 选择器（~3 行修改）

### 🎯 最佳实践

**样式表隔离原则**：
1. 为需要设置样式的主窗口设置 `objectName`
2. 使用 `#objectName` 选择器精确定位
3. 避免使用裸的 `setStyleSheet()` 影响整个组件树
4. 子组件（对话框）保持默认样式或单独设置

**适用场景**：
- 主窗口需要动态背景
- 对话框需要固定样式
- 多层级组件需要样式隔离

### 🔍 相关问题

**Q: 为什么不直接给对话框设置白色背景？**
A: 对话框可能很多，逐个设置工作量大。从源头隔离样式更优雅。

**Q: 这个方法是否影响其他 UI 组件？**
A: 不影响。`#ChatWindow` 选择器只匹配主窗口，其他组件保持默认样式。

**Q: 是否需要清理旧样式表？**
A: PyQt6 的 `setStyleSheet()` 会覆盖之前的样式，无需手动清理。

### 📊 修复前后对比

| 场景 | 修复前 | 修复后 |
|------|--------|--------|
| 静态壁纸 + 对话框 | 背景透明/显示图片 ❌ | 背景白色 ✅ |
| 动态壁纸 + 对话框 | 背景正常 ✅ | 背景正常 ✅ |
| 切换壁纸 + 对话框 | 背景异常 ❌ | 背景正常 ✅ |

---

## 🎨 折叠按钮样式更新

### 🔄 样式变更

**修改前**：
- 透明背景，蓝色文字
- 简约风格

**修改后**：
- 红色渐变背景（#FF6B6B → #EE5A6F）
- 白色文字，14px 圆角
- Hover 效果：边框高亮 + 轻微缩放

### 📝 样式代码

```python
button_style = """
    QPushButton {
        background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                                    stop:0 #FF6B6B, stop:1 #EE5A6F);
        color: white;
        border: 2px solid transparent;
        border-radius: 14px;
        padding: 8px 20px;
        font-size: 13px;
        font-weight: bold;
    }
    QPushButton:hover {
        border: 2px solid rgba(255, 107, 107, 0.8);
        transform: scale(1.05);
    }
    QPushButton:pressed {
        background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                                    stop:0 #EE5A6F, stop:1 #DD4A5E);
    }
"""
```

### 🎯 设计理念

- **红色系**：与主题配色一致，醒目但不突兀
- **圆角设计**：柔和友好
- **渐变背景**：增加视觉层次
- **Hover 反馈**：提升交互体验

### 📸 效果展示

```
收起状态：
┌─────────────────────────────┐
│ 这是一段很长的文本内容...   │
│ [  展开全文 ▼  ]  (红色按钮)│
└─────────────────────────────┘

展开状态：
┌─────────────────────────────┐
│ 这是一段很长的文本内容      │
│ 包括所有详细说明...         │
│ [   收起 ▲   ]  (红色按钮)  │
└─────────────────────────────┘
```

---

## 📊 总结

### 本次更新内容

1. **长文本智能折叠**：
   - 新增 `CollapsibleBubbleLabel` 类（约 100 行代码）
   - 添加配置界面（约 90 行代码）
   - 配置持久化到 `theme_settings.json`

2. **对话框背景修复**：
   - 修复 `chat_ui.py` 样式继承问题（3 处修改）
   - 使用 CSS 选择器精确控制样式作用范围
   - 确保所有子对话框背景正常

### 文件修改统计

- `chat_area.py`：+100 行（新增折叠组件）
- `dialogs.py`：+90 行（配置界面）
- `chat_ui.py`：修改 3 处（对象名称 + 2 处样式表）
- `theme_settings.json`：+2 个配置项（折叠阈值、预览长度）
- `UPDATE_2025-10-19.md`：+450 行（本文档）
- `README.md`：更新版本号和功能说明

### 测试状态

- ✅ 长文本折叠功能（展开/收起）
- ✅ 折叠配置保存/加载
- ✅ 折叠按钮样式（红色渐变）
- ✅ 对话框背景修复（动态→静态）
- ✅ 对话框背景修复（静态→动态）
- ✅ 多次切换壁纸类型测试
- ⏳ 多平台测试（仅测试 Windows）

### 技术亮点

1. **智能折叠算法**：自动检测文本长度，动态显示/隐藏按钮
2. **CSS 选择器应用**：精确控制样式继承，避免子组件污染
3. **配置持久化**：用户设置自动保存，提升用户体验
4. **红色主题统一**：按钮样式与应用整体风格保持一致

---

**开发日期**: 2025年10月19日  
**版本**: V1.0.10  
**开发者**: GitHub Copilot  
**提交者**: bannerdekra

